#!/usr/bin/env bash
# post-init-project.sh - Protects organization standards after project initialization
# Part of /init-project command workflow

set -eo pipefail

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Configuration
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PROJECT_NAME="${1:-$(basename "$(pwd)")}"
CLAUDE_DIR="$HOME/.claude"
CLAUDE_MD="$CLAUDE_DIR/CLAUDE.md"
ORGANIZATION_MD="$CLAUDE_DIR/ORGANIZATION.md"
PROJECT_DIR="$CLAUDE_DIR/projects/$PROJECT_NAME"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Helper Functions
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

print_header() {
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "ğŸ”§ Post-Init: Protecting Organization Standards"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
}

print_step() {
    echo "âš™ï¸  $1"
}

print_success() {
    echo "âœ… $1"
}

print_warning() {
    echo "âš ï¸  $1"
}

print_error() {
    echo "âŒ $1"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Main Logic
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

print_header

# Step 1: Check if ORGANIZATION.md exists
if [ ! -f "$ORGANIZATION_MD" ]; then
    print_warning "ORGANIZATION.md not found - creating from CLAUDE.md"

    # Extract organization standards from current CLAUDE.md
    if [ -f "$CLAUDE_MD.backup" ]; then
        print_step "Extracting organization standards from backup..."

        # Create ORGANIZATION.md from backup (everything before project-specific content)
        awk '/^## Project Context|^## Project-Specific/,0 {exit} {print}' "$CLAUDE_MD.backup" > "$ORGANIZATION_MD"

        print_success "Created ORGANIZATION.md from backup"
    else
        print_error "Cannot create ORGANIZATION.md - no backup found"
        print_warning "Organization standards may be lost"
        print_warning "Recommendation: Run claude-config.sh to restore"
        exit 1
    fi
fi

# Step 2: Backup current CLAUDE.md
if [ -f "$CLAUDE_MD" ]; then
    print_step "Backing up current CLAUDE.md..."
    cp "$CLAUDE_MD" "$CLAUDE_MD.backup-$(date +%Y%m%d-%H%M%S)"
    print_success "Backup created"
fi

# Step 3: Reconstruct CLAUDE.md with protected structure
print_step "Reconstructing CLAUDE.md with protected standards..."

cat > "$CLAUDE_MD" << 'EOF'
# CLAUDE.md - Claude Code Configuration

**Status**: Multi-layer configuration (Organization + Project + Vision)
**Auto-generated by**: /init-project command
**Last Updated**: $(date +%Y-%m-%d)

---

## ğŸ›¡ï¸ Organization Standards (Protected)

**DO NOT EDIT**: This section is managed by claude-config.sh
**To update**: Run `claude-config.sh <persona>` to reinstall

@include ORGANIZATION.md

---

## ğŸ“‚ Project Context (Auto-loaded)

**Project Name**: ${PROJECT_NAME}
**Auto-detected from**: Environment variable, git repository, or directory name

EOF

# Add project-specific includes if PROJECT.md exists
if [ -f "$PROJECT_DIR/PROJECT.md" ]; then
    cat >> "$CLAUDE_MD" << EOF
### Project Configuration
@include projects/\${PROJECT_NAME}/PROJECT.md

EOF
    print_success "Added PROJECT.md include"
fi

# Add vision document include if VISION.md exists
if [ -f "$PROJECT_DIR/VISION.md" ]; then
    cat >> "$CLAUDE_MD" << EOF
### Vision Document
@include projects/\${PROJECT_NAME}/VISION.md

EOF
    print_success "Added VISION.md include"
fi

# Add footer
cat >> "$CLAUDE_MD" << 'EOF'
---

## ğŸ“Š Session Information

**Current Working Directory**: $(pwd)
**Project**: ${PROJECT_NAME}
**Persona**: ${CLAUDE_PERSONA:-not-set}
**Context Layers**: Organization â†’ Project â†’ Vision

---

## ğŸš€ Quick Commands

### Project Management
- `/init-project <name>` - Initialize new project (preserves org standards)
- `/sync-context` - Reload project and vision context

### Vision-Driven Development
- `/create-vision-doc` - Generate vision document for current project
- `/update-vision` - Update vision based on implementation learnings
- `/validate-vision` - Validate vision against completeness checklist
- `/implement --phase N` - Execute autonomous development for phase N

### Context Management
- `/switch-persona <persona>` - Switch to different persona (engineer|qa|em|pm|ux)
- `/load-project <name>` - Load different project context

---

## ğŸ’¡ How This Works

### 3-Layer Architecture

1. **Organization Layer** (ORGANIZATION.md)
   - Company-wide coding standards
   - Approved technology stack
   - Security policies
   - Development workflow
   - **Never changes per-project**

2. **Project Layer** (projects/${PROJECT_NAME}/PROJECT.md)
   - Project-specific architecture
   - Team composition
   - File structure
   - Integration points
   - **Stable during project lifetime**

3. **Vision Layer** (projects/${PROJECT_NAME}/VISION.md)
   - Strategic direction
   - Implementation roadmap
   - Success criteria
   - Architectural decisions
   - **Living document, updated sprint-by-sprint**

### Variable Substitution

Claude Code automatically substitutes these variables:
- `${PROJECT_NAME}` - Auto-detected from $CLAUDE_PROJECT, git, or directory
- `${CLAUDE_PERSONA}` - Current active persona (engineer|qa|em|pm|ux)
- `$(pwd)` - Current working directory
- `$(date)` - Current date

---

*Protected by /init-project command | Organization standards preserved*
EOF

print_success "CLAUDE.md reconstructed with protected structure"

# Step 4: Verify includes are valid
print_step "Verifying include paths..."

if [ -f "$ORGANIZATION_MD" ]; then
    print_success "ORGANIZATION.md exists"
else
    print_error "ORGANIZATION.md missing!"
fi

if [ -f "$PROJECT_DIR/PROJECT.md" ]; then
    print_success "PROJECT.md exists"
else
    print_warning "PROJECT.md not found (may be created separately)"
fi

if [ -f "$PROJECT_DIR/VISION.md" ]; then
    print_success "VISION.md exists"
else
    print_warning "VISION.md not found (create with /create-vision-doc)"
fi

# Step 5: Summary
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… Organization standards protected successfully!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Structure:"
echo "  ğŸ›¡ï¸  ORGANIZATION.md (protected)"
echo "  ğŸ“ CLAUDE.md (reconstructed)"
echo "  ğŸ“‚ projects/$PROJECT_NAME/ (project-specific)"
echo ""
echo "Your organization standards are safe across all projects! ğŸ‰"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
